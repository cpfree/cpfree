---
keys: 
type: trim
url: <>
id: 220215-171567
---

# mysql-innodb

> 参考书籍: <<mysql 是怎样运行的>>

## innodb 页简介

innodb 采取的方式是, 将数据分为若干个页, 以页作为磁盘和内存之间交互的基本单位

每个页默认 16kb, 一般情况下, 每次至少和磁盘进行交互 16kb 的数据.

> 系统变量 `innodb_page_size` 标记着这个大小, 默认是 `16384` (16kb), 该变量智能在 mysql 第一次数据库初始化的时候指定.

## innodb 行格式

#### CAMPACT 格式

![](https://gitee.com/cpfree/picture-warehouse/raw/master/pic1/1644821930847.png)

1. 变长字段长度列表:

   所有变长字段的真实数据占用的字节数都存放在记录的开头位置, 形成一个变长字段长度列表.

   各边长字段存储值, **逆序存放**

2. NULL 值列表

   CAMPAT 行格式会统计行数据中可以为 NULL 的字段, 之后按真实的内容以字节的形式**逆序存放**

   如果行里面有三个字段 c1, c3, c4 可以为`null`, 而三者的数据 c3, c4 为 null, c1 不为 null

   则由于只有三个字段, 因此 NULL 值列表, 只需要 8 位字节, 存放的值为 `00000110`

3. 记录头信息

   ![](https://gitee.com/cpfree/picture-warehouse/raw/master/pic1/1644824193799.png)

   内容很多, 没必要记住.

### 记录的真实数据

| 列名         | 是否必须 | 占用空间 | 描述     |
| ------------ | -------- | -------- | -------- |
| row_id       | 否       | 6 字节   | 行 ID,   |
| trx_id       | 是       | 6 字节   | 事务 id  |
| roll_pointer | 是       | 7 字节   | 回滚指针 |

innodb 表主键生成策略

1. 优先使用自定义的主键作为主键
2. 若没有自定义主键, 选取一个不允许存储为 null 的 unique 键作为主键
3. 若上面两条均没有, 则默认添加一个名为 row_id 的列作为主键.

## innodb 页

![](https://gitee.com/cpfree/picture-warehouse/raw/master/pic1/1644825246160.png)

innodb 为了不同的目的, 设计了不同类型的页, 一个数据页可以被大致划分为 7 个部分，分别如下。

| 名称               | 占位       | 描述                                                                                                           |
| ------------------ | ---------- | -------------------------------------------------------------------------------------------------------------- |
| FileHeader         | 38 字节    | 表示页的一些通用信息                                                                                           |
| PageHeader         | 56 字节    | 表示数据页专有的一些信息                                                                                       |
| Infimum + Supremum | 26 字节    | 两个虚拟的伪记录，分别表示页中的最小记录和最大记录                                                             |
| User Records       | 大小不固定 | 真正存储我们插入的记录                                                                                         |
| Freespace          | 大小不固定 | 页中尚未使用的部分                                                                                             |
| Page Directory     | 大小不固定 | 页中某些记录的相对位置，也就是各个槽对应的记录在页面中的地址偏移量；插入的记录越多，这个部分占用的空间就越多。 |
| File Trailer       | 8 字节     | 用于检验页是否完整                                                                                             |

用户数据和记录头信息

每个记录的头信息中都有一个 next record 属性，从而可以使页中的所有记录串联成一个单向链表。

![](https://gitee.com/cpfree/picture-warehouse/raw/master/pic1/1644825366451.png)

页面结构分组信息

每个数据页的 File Header 部分都有上一个页和下一个页的编号，所以所有的数据页会组成一个双向链表。

![](https://gitee.com/cpfree/picture-warehouse/raw/master/pic1/1644825446167.png)

InnoDB 会把页中的记录划分为若干个组，每个组的最后一个记录的地址偏移量作为一个槽，存放在 page Directory 中，一个槽占用 2 字节。

在一个页中根据主键查找记录是非常快的，分为两步。

1. 通过 2 分法, 确定该纪录所在分组对应的槽中, 然后找到该槽所在分组中主键值最小的那条记录

2. 通过记录的 next_record 属性遍历该槽所在的组中的各个记录.

在将页从内存刷新到磁盘时，为了保证页的完整性，页首和页尾都会存储页中数据的校验和，以及页面最后修改时对应的 LSN 值（页尾只会存储 LSN 值的后 4 字节）。如果页首和页尾的校验和以及 LSN 值校验不成功，就说明刷新期间出现了问题。
