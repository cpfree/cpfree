# design-question

## 为什么 zookeeper 节点是奇数

在每台机器数据保持一致的情况下，zookeeper 集群可以保证，客户端发起的每次查询操作，集群节点都能返回同样的结果。

但是对于客户端发起的修改、删除等能改变数据的操作呢？集群中那么多台机器，你修改你的，我修改我的，最后返回集群中哪台机器的数据呢？

这就是一盘散沙，需要一个领导，于是在 zookeeper 集群中，leader 的作用就体现出来了，只有 leader 节点才有权利发起修改数据的操作，而 follower 节点即使接收到了客户端发起的修改操作，也要将其转交给 leader 来处理，leader 接收到修改数据的请求后，会向所有 follower 广播一条消息，让他们执行某项操作，follower 执行完后，便会向 leader 回复执行完毕。当 leader 收到半数以上的 follower 的确认消息，便会判定该操作执行完毕，然后向所有 follower 广播该操作已经生效。

所以 zookeeper 集群中 leader 是不可缺少的，但是 leader 节点是怎么产生的呢？其实就是由所有 follower 节点选举产生的，讲究民主嘛，而且 leader 节点只能有一个，毕竟一个国家不能有多个总统。

这个时候回到我们的小标题，为什么 zookeeper 节点数是奇数，我们下面来一一来说明：

1. 容错率

   首先从容错率来说明：（需要保证集群能够有半数进行投票）

   2 台服务器，至少 2 台正常运行才行（2 的半数为 1，半数以上最少为 2），正常运行 1 台服务器都不允许挂掉，但是相对于 单节点服务器，2 台服务器还有两个单点故障，所以直接排除了。

   3 台服务器，至少 2 台正常运行才行（3 的半数为 1.5，半数以上最少为 2），正常运行可以允许 1 台服务器挂掉

   4 台服务器，至少 3 台正常运行才行（4 的半数为 2，半数以上最少为 3），正常运行可以允许 1 台服务器挂掉

   5 台服务器，至少 3 台正常运行才行（5 的半数为 2.5，半数以上最少为 3），正常运行可以允许 2 台服务器挂掉

2. 防脑裂

   脑裂集群的脑裂通常是发生在节点之间通信不可达的情况下，集群会分裂成不同的小集群，小集群各自选出自己的 leader 节点，导致原有的集群出现多个 leader 节点的情况，这就是脑裂。

   3 台服务器，投票选举半数为 1.5，一台服务裂开，和另外两台服务器无法通行，这时候 2 台服务器的集群（2 票大于半数 1.5 票），所以可以选举出 leader，而 1 台服务器的集群无法选举。

   4 台服务器，投票选举半数为 2，可以分成 1,3 两个集群或者 2,2 两个集群，对于 1,3 集群，3 集群可以选举；对于 2,2 集群，则不能选择，造成没有 leader 节点。

   5 台服务器，投票选举半数为 2.5，可以分成 1,4 两个集群，或者 2,3 两集群，这两个集群分别都只能选举一个集群，满足 zookeeper 集群搭建数目。

   以上分析，我们从容错率以及防止脑裂两方面说明了 3 台服务器是搭建集群的最少数目，4 台发生脑裂时会造成没有 leader 节点的错误。

## zookeeper 读写

写处理它比在 ZooKeeper 集群过程是昂贵的

| action         | summary                                                                                                                          |
| -------------- | -------------------------------------------------------------------------------------------------------------------------------- |
| 写入           | 写过程是由领导节点处理。领导者转发写请求到所有 znodes 及其等待来自 znodes 应答。如果一半的 znodes 的回复，那么写入过程就完成了。 |
| 读取           | 读取在内部由特定连接 znode 进行的，所以没有必要与集群交互。                                                                      |
| 复制数据库     | 它是用来将数据存储在 zookeeper。每个 znode 都有自己的数据库及其每个 znode 在一致性的作用下，每次有相同的数据。                   |
| 领导者（节点） | 领导者是由 Znode 负责处理写请求。                                                                                                |
| 追随者（节点） | 追随者收到来自客户端的写请求，并将其转发到领导 znode。                                                                           |
| 请求处理器     | 目前仅在领导节点。它从跟随节点的请求支配写入。                                                                                   |
| 原子广播       | 负责从领导节点到从节点广播更改。                                                                                                 |
