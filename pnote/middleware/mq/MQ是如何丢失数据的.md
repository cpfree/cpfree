# MQ 消息发送流程

> <https://baijiahao.baidu.com/s?id=1662095398693413299&wfr=spider&for=pc>

一条消息从生产到被消费，将会经历三个阶段

![](https://gitee.com/cpfree/picture-warehouse/raw/master/pic1/1644566463164.png)

生产阶段: Producer 新建消息，然后通过网络将消息投递给 MQ Broker
存储阶段: 消息将会存储在 Broker 端磁盘中
消息阶段: Consumer 将会从 Broker 拉取消息

以上任一阶段都可能会丢失消息，我们只要找到这三个阶段丢失消息原因，采用合理的办法避免丢失，就可以彻底解决消息丢失的问题。


## 生产阶段: 发送消息到MQ

1. 正常流程

   生产者发送数据到broker, broker收到数据之后, 就会发送ack回馈.

   如果生产者收到 ACK 回馈, 就可以保证生产阶段消息没有丢失

2. 同步发送消息: 设计一个send 方法, 如果send方法没有抛出异常, 受到ACK后成功结束, 就可以认为消息成功发送了.

   ![](https://gitee.com/cpfree/picture-warehouse/raw/master/pic1/1644566920689.png)

3. 异步发送消息: 设计异步回馈方法, 如果之后有报错, 也在异步信息里面进行处理.

   ![](https://gitee.com/cpfree/picture-warehouse/raw/master/pic1/1644566948481.png)

#### 失败

1. 网络问题: 异常报错
   这个很容易, 根据不同网络.

2. 网络超时

   1. 对方没有成功收到消息.
   2. 对方收到消息后, 没有成功反馈.

3. 网络抖动

#### 生产阶段超时解决方法

1. 网络失败重试

   不管是同步还是异步的方式，都会碰到网络问题导致发送失败的情况。针对这种情况，我们可以设置合理的重试次数，当出现网络问题，可以自动重试。设置方式如下：

2. 消息序列号设计

   1. 可以解决数据的完整性
   2. 可以知道哪些数据没有收到, 去重新获取数据
   3. 有了序列号还可以根据序列号设置幂等性.

## Broker 存储阶段

### 单节点流程

   默认流程: 消息只要到了 Broker 端，将会优先保存到内存中，然后立刻返回确认响应给生产者。随后 Broker 定期批量的将一组消息从内存异步刷入磁盘。

   异常情况: 机器掉电，异常宕机等情况，消息还未及时刷入磁盘，就会出现丢失消息的情况。

   提高可靠性方式: 将消息保存机制修改为同步刷盘方式，即消息存储磁盘成功，才会返回响应。同步刷盘相对于IO时间很短, 这个实际上是可以考虑的.

### 集群部署流程(主从或节点间复制出现问题)

   Broker 通常采用一主（master）多从（slave）部署方式。为了保证消息不丢失，消息还需要复制到 slave 节点。

   默认流程: 消息写入 master成功，就可以返回确认响应给生产者，接着消息将会异步复制到 slave 节点。

   异常情况: 
      master 宕机且不可恢复, 那么未复制到salve中的数据将会丢失.
      salve宕机没关系, 重新恢复的时候到master里面去同步数据就好.

   提高可靠性方式: 采用同步的复制方式，master节点将会同步等待 slave 节点复制完成，才会返回确认响应。

   缺点: 由于又经历了一次发送, 因此理论会增加一倍时间, 降低性能

## 消费消息

默认流程: 消费者从 broker 拉取消息，然后执行相应的业务逻辑。一旦执行成功，将会返回 ConsumeConcurrentlyStatus.CONSUME_SUCCESS 状态给 Broker。

异常情况

   1. broker未收到consumer消费成功的ACK回馈.

   2. broker收到consumer的其他状态消息.

      此时consumer或者是其它的consumer下次还会收取到该信息

      





提高消息可靠性，但是可能导致消息重发，重复消费。所以对于消费客户端，需要注意保证幂等性。