# 第 2 章 Java 虚拟机的结构

参考网址: <https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html>

## 数据类型

Java 虚拟机对两种类型进行操作：**原始类型** 和**引用类型**。相应地，有两种值可以存储在变量中、作为参数传递、由方法返回和操作：**原始值**和**引用值**。

**Java 虚拟机期望几乎所有类型检查都在运行时之前完成，通常由编译器完成，而不必由 Java 虚拟机本身完成。**
原始类型的值不需要被标记或以其他方式可检查以确定它们在运行时的类型，或与引用类型的值区分开来。

Java 虚拟机包含对对象的显式支持。**一个对象要么是一个动态分配的类实例，要么是一个数组**。对对象的引用被认为具有 Java 虚拟机类型 reference。类型的值 reference 可以被认为是指向对象的指针。可能存在多个对一个对象的引用。对象总是通过类型的值进行操作、传递和测试 reference。

### Primitive Types and Values

Java 虚拟机支持的基本数据类型是数值类型、布尔类型和 returnAddress 类型

- 数值类型包括整型和浮点类型。
- 布尔类型的值对真值 true 和 false 进行编码，默认值为 false。
- returnAddress 类型的值是指向 Java 虚拟机指令操作码的指针。在基元类型中，只有 returnAddress 类型与 Java 编程语言类型没有直接关联。

1. 数值类型(numeric types)
   - 整数类型
     byte 8 位 有符号二进制补码整数，默认值为 0
     short 16 位 有符号二进制补码整数，默认值为 0
     int 32 位 有符号二进制补码整数，默认值为 0
     long 64 位 有符号二进制补码整数，默认值为 0
     char 16 位 无符号整数、UTF-16 编码，默认为 null（'u0000'）
   - 浮点数类型
     float 32 位单精度（IEEE 754 标准）, 默认值为正零
     double 64 位单精度（IEEE 754 标准）, 默认值为正零
     > IEEE 754 标准不仅包括正号和负号幅度数字，还包括 `正数0`、`负数0`、`正无穷大`、`负无穷大`、`NaN`(Not-a-Number, 表示某些无效操作的结果，例如零除以零)
     > 除了 NaN 之外，其他值都是 有序的, 任何数字与 NaN 比较都会返回 false(NaN 和 NaN 比较同样返回 false)
2. boolean
   布尔类型的值对真值 true 和 false 进行编码，默认值为 false。
   在 Java 编程语言中对布尔值进行操作的表达式被编译为使用 Java Virtual Machine int 数据类型的值。
   在 Oracle 的 Java 虚拟机实现中，Java 编程语言中的布尔数组被编码为 Java 虚拟机字节数组，每个布尔元素使用 8 位。
3. returnAddress
   returnAddress 值指向虚拟机一个地址, 类型不对应于任何 Java 编程语言类型，并且不能被正在运行的程序修改。

### 参考类型及参考值(Reference Types and Values)

有三种引用类型: `类类型`、`数组类型`和`接口类型`。它们的值分别是对动态创建的类实例、数组或实现接口的类实例或数组的引用。

数组类型由具有单个维度的组件类型组成(其长度不是由类型给出的)。 数组类型的组件类型本身可以是数组类型。 如果从任何数组类型开始，考虑其组件类型，然后(如果也是数组类型)考虑该类型的组件类型，以此类推，最终必须到达非数组类型的组件类型; 这称为数组类型的元素类型。 数组类型的元素类型必然是基元类型、类类型或接口类型。

> 数据最外维是 组件类型，最里面维度称为 元素类型。如 List，其中 List 是组件类型，Integer 是元素类型。

引用值也可以是特殊的 null 引用，对 no 对象的引用，这里将用 null 表示。空引用最初没有运行时类型，但可以强制转换为任何类型。引用类型的默认值为空。

## 对象的表示

在 Java 虚拟机的一些 Oracle 实现中，对类实例的引用是指向一个句柄的指针，
该句柄本身就是一对指针: 一个指向表示对象类型的 Class 对象的指针，另一个指向从堆中为对象数据分配的内存。

## 附录

### Java 虚拟机中的实际和计算类型

| 实际类型      | 计算类型      | Category |
| ------------- | ------------- | -------- |
| boolean       | int           | 1        |
| byte          | int           | 1        |
| char          | int           | 1        |
| short         | int           | 1        |
| int           | int           | 1        |
| float         | float         | 1        |
| reference     | reference     | 1        |
| returnAddress | returnAddress | 1        |
| long          | long          | 2        |
| double        | double        | 2        |
