# 关于乱码问题, 你可能不知道的知识和原理

> 关于这个控制台乱码问题, 最初我都是随便配置了一些编码, 只要使日志正常显示之后就不再管它了, 但是最近遇到了各种奇葩的乱码问题, 尤其是帮别的项目或帮同事处理代码问题的时候, 乱码问题真的是五花八门, 群魔乱舞, 于是我抽了个周末好好研究了下乱码这个问题, 在此做下记录, 方便大家处理乱码问题

本篇研究以 Java 为代码, 集成开发环境为 IDE, 操作系统为 window10

## 简单分析可能造成乱码的原因

首先我们要知道什么是乱码, 简而言之**乱码就是文件打开的编码方式和文件本身编码方式不对**, 注意这个地方有**两个编码**, 一个是**文件本身的编码**, 一个是**用什么编码打开文件**, 两个编码不对应, 就会出现乱码.

例如以下图片(控制台乱码)

![在这里插入图片描述](https://gitee.com/cpfree/picture-warehouse/raw/master/pic/20210610121405.png)

> 关于这个 `淇℃伅`, 我可以明确告诉你们这个是 UTF-8 编码`信息`,, 那为什么会显示成`淇℃伅`呢, 是因为控制台以 GBK 的方式显示 UTF-8 编码.

---

## 深入分析乱码原理

### 1. 首先让我们列举下我们可能用到的编码有哪些

| 编码  | 解释                                                                                            |
| ----- | :---------------------------------------------------------------------------------------------- |
| GBK   | 汉字内码扩展规范, 向下与 GB 2312 编码兼容，向上支持 ISO 10646.1 国际标准，window 中国区默认编码 |
| UTF-8 | 针对 Unicode 的一种可变长度字符编码。兼容于 ASCII 编码, 国际比较通用的编码格式                  |

1. 在一些编译器里面也许有 ANSI 这种编码, 但实际上 ANSI 并不是特指某一种具体的编码, 这里以 window 为例, 假如你 window 电脑的区域和语言是中国, 那么“ANSI 编码”实际是 GBK 编码。当你把它改成 Korean(Korea)时，“ANSI 编码”实际是 EUC-KR 编码，当你把它改成 English(US)时，“ANSI 编码”实际是 ASCII 编码.
2. UTF-16 是 JDK String 的存储编码, 但一般来说, 你只要不对 char 数组进行 bit 解析, 至少你在日志中一般不会碰到 UTF-16 的情况.
3. 综上分析, 我们只需要研究下`GBK` 和 `UTF-8` 两种编码格式即可.

### 2. 其次让我们分析下 JAVA IDEA 开发中涉及到的编码配置可能有哪些

列举所有可能出现的情况大概就以下几种, 先别管对不对, 只要可能的就先列举上

   1. java 源文件编码.
   2. java编译成的class文件编码.
   3. jvm 以什么编码格式运行class文件.
   4. jvm 以什么方式输出日志
   5. 控制台以什么编码格式显示输出日志.
   6. 系统默认编码
   7. log 日志输出编码(log4j, log4j2, logback).

---

## <font color="blue">接下来让我们通过问答的方式大家明白几个解释起来比较散乱的常识</font>

---

### <font color="red">Q1: java 源代码会对乱码有影响吗</font>

<font color="green">A: **`源文件编码格式对乱码没什么影响`**</font>

事实上**不管你 java 源代码用的是什么编码格式, 编译成的 class 文件都是一样的, 而 class 文件编码貌似只有一种, 盲猜应该是`UTF-16`.**

> 下面是我将**内容同样而编码格式不同的两份源码**编译成的两个 class 文件属性图, 通过文件算码发现两个 class 文件完全一致.
> ![在这里插入图片描述](https://gitee.com/cpfree/picture-warehouse/raw/master/pic/20210610121412.png)
> 所以那些一乱码就乱改文件格式的行为实际上对乱码是没有什么帮助的 😔

---

### <font color="red">Q2: -Dfile.encoding 到底是什么</font>

在命令行中输入 java，在给出的提示中会出现 -D 的说明：

```dos
-D<name>=<value> # set a system property
```

也就是说 -D 后面需要跟一个键值对，作用是设置一项系统属性
-Dfile.encoding=UTF-8 来说就是设置系统属性 file.encoding 为 UTF-8

### <font color="red">Q3: file.encoding 到底是有什么用</font>

**JVM 在运行时有一个属性 `file.encoding`, 这个 `file.encoding` 的值, 默认是系统编码(中国大陆 window 系统编码默认是 GBK), 但是如果在 JVM 启动时加一个参数 `-Dfile.encoding=UTF-8`, 那么获取 `file.encoding` 的值就变成了`UTF-8`,**

**这个`file.encoding`可重要了, 它不仅控制着 JVM 运行时的编码格式, 还控制着 `System.out.println()` 打印到控制台的输出编码格式, 而且类似于 IDEA 这类 IDE 在显示控制台的时候还会通过 `file.encoding` 确定控制台用什么编码来解析日志.**

> 关于`file.encoding`, 在 java 代码中获取它的值的代码是 `System.getProperty("file.encoding")` 或 `Charset.defaultCharset().name()`.
>
> 在此说一个题外话, 例如在项目启动处, 例如 Springboot 启动处添加一句下面的代码对乱码时的解决是很有帮助的.
>
> ```java
> log.info("file.encoding: {}", System.getProperty("file.encoding"));
> ```

### <font color="red">Q4: console.encoding 是什么</font>

A: 老实说我自己现在都没搞明白这个到底是个什么玩意

> 关于这个实际上可以在 IDEA 官网看到这样的内容
> ![在这里插入图片描述](https://gitee.com/cpfree/picture-warehouse/raw/master/pic/20210610121425.png)
>
> 翻译成中文就是
> ![在这里插入图片描述](https://gitee.com/cpfree/picture-warehouse/raw/master/pic/20210610121431.png)
>
> 然而我照着上面试过之后发现, 无论我怎么添加配置后重启, 最终都没什么卵用, 为此这几天我特意将 IDEA 从`2019.3.3`升级到了`2020.3`, 但是发现还是没什么用, 最终决定控制台输出编码的还是`file.encoding`, 如果有小伙伴知道, 这个有什么用的话, 欢迎留言![在这里插入图片描述](https://gitee.com/cpfree/picture-warehouse/raw/master/pic/20210610121437.png)

### <font color="red">Q5: log 日志配置对乱码有影响吗</font>

A:关于 log 日志, 我只想说的就是, 日常 90%的乱码都是因为 log 日志没有配置好而引起的.

> 绝大多数日志乱码情况下, 大家都是去改 IDEA 配置, 改 `file.encoding`, 但事实上是 IDEA 配置是没有问题的, 即便你的配置有些小问题, java 语言和 IDEA 的智能性也能帮你显示成正确的编码, 然后大家的处理方式就成了 **明明是 Log 日志配置不对, 却偏偏去改 IDEA 配置, 致使 IDEA 去适应 log**, 这样**即使最后显示正确的编码, 实际上也是没有灵魂的**.

1. 首先我想说明一点, log4j 实际上是有很多问题的, 例如就有版本问题和各种乱码问题.
2. 而且 `log4j` 比较恶心的是有些版本默认输出编码格式遵循 `file.encoding`, 还有的默认 `系统编码格式`, 也就是说, 有些垃圾版本即便你改了`file.encoding=UTF-8`也没用, 它依然遵循系统默认 GBK 编码.

   > 而且都什么年代了, 别用`log4j`了, 换 `log4j2` 吧

### <font color="red">Q6: log 配置文件中编码如何配置(以 log4j2 配置为例)</font>

A: 以 log4j2 配置为例, 如下图配置文件, 从上至下, 让我们一个个解析
> ![log4j配置](https://gitee.com/cpfree/picture-warehouse/raw/master/pic/20210610121444.png)

1. 首先第一个 `encoding`, 这个 `encoding` 跟你的乱码一般没什么关系的, 它管理的是 log 配置文件的编码格式, 也就是说它管理的是日志插件以什么格式去解析`log4j2.xml`, 这个配置文件.

   > 知道 Html 吧, 第一个 encoding 和 html 文件标题头上面的 `encoding` 是类似的.
   > 关于这个地方有个小 Tip, 例如在 IDEA 里面, 只要你把文件头的这个`encoding`从 GBK 改成 UTF-8, 然后 IDEA 就会自然的把你整个文件的编码格式给改成 UTF-8 了.

2. 如上图中的 2 处和 3 处的`<PatternLayout charset="GBK" pattern="%m%n" />`, 这个配置管理的才是输出到你的控制台或者是文件的编码, 当然你也可以写成

   ```xml
   <PatternLayout charset="GBK" pattern="%m%n" />
   ```

   > 注意这个配置是 log4j2 的配置, 如果你使用的是 log4j 或者是 logback, 请在网上搜索相应的编码配置.

### <font color="red">Q7: 如何找出具体乱码是如何乱成那样的</font>

想要知道你的乱码为什么乱码成那样, 请先在你的程序里面打印输出 `0信1息2信息3`,之后看下乱码情况是以下解码后显示的哪一种乱码, 应该就能找到你的乱码是如何乱码成你看到的样子的.

> 如下第 6 行, 原信息是`0信1息2信息3`, 编码格式是 UTF-8 编码, 但是以 GBK 的方式对其进行解码后就变成了`0淇�1鎭�2淇℃伅3`.

| 原信息             | 原信息编码格式                | 解码方式           | 解码后显示              |
| ------------------ | ----------------------------- | ------------------ | ----------------------- |
| 0 信 1 息 2 信息 3 | _ASCII,**UTF_8,**UTF_16, GBK_ | 同编码方式一样     | 0 信 1 息 2 信息 3      |
| 0 信 1 息 2 信息 3 | US-ASCII                      | US-ASCII,UTF-8,GBK | 0?1?2??3                |
| 0 信 1 息 2 信息 3 | US-ASCII                      | UTF-16             | 〿ㄿ㈿㼳                 |
| 0 信 1 息 2 信息 3 | UTF-8                         | US-ASCII           | 0���1���2������3        |
| 0 信 1 息 2 信息 3 | UTF-8                         | UTF-16             | ヤ뾡㇦ 膯㋤뾡꼳        |
| 0 信 1 息 2 信息 3 | UTF-8                         | GBK                | 0 淇 �1 鎭 �2 淇 ℃ 伅 3 |
| 0 信 1 息 2 信息 3 | UTF-16                        | US-ASCII,UTF-8     | �� 0O� 1`o 2O�`o 3      |
| 0 信 1 息 2 信息 3 | UTF-16                        | GBK                | � 0O� 1`o 2O 醏 o 3     |
| 0 信 1 息 2 信息 3 | GBK                           | US-ASCII           | 0��1��2����3            |
| 0 信 1 息 2 信息 3 | GBK                           | UTF-8              | 0��1Ϣ2��Ϣ3              |
| 0 信 1 息 2 信息 3 | GBK                           | UTF-16             | バ씱쾢㋐엏ꈳ            |

> 上面的表格只是列举了我们绝大多数情况下涉及到的编码 US-ASCII,UTF-8,GBK,UTF-16, 可能你用了之外的其它编码,
> 另外上面也仅仅是展示了一层转换而已, 可能有以错误编码解码后再次被引用之后再次解码的多次错误转换的情况, 例如 UTF 编码的信息 f 以 GBK 的方式解码后变成了淇 ℃ 伅之后再以 UTF-8 的形式存储后, 再以 GBK 方式打开, 就变成了娣団剝浼 �😀.

## <font color="green">乱码的解决方案</font>

1. 添加 vm 启动参数 (无论是 UTF-8 还是 GBK 都可以, 这里以 UTF-8 为例)`-Dfile.encoding=UTF-8`.
2. log 日志中添加配置编码配置, 以上面的 log4j2 配置为例, 如果你用的是 log4j, 或是些旧版本的 log 日志框架, 那么最好在每个控制台或文件输出的地方都配置上和第一步同样的编码.

   > 因为你不配置的话, 它就会使用默认编码, 而不同的日志框架的默认编码可能是不同的, 这个默认编码可能依照的是`file.encoding`属性, 也可能是系统默认编码

3. 如果还出现问题, 就清下缓存
   > 这个地方提示一下, IDEA 实际上是由很多 Bug 的, 前几天 IDEA 2020.3 发布之后, 我马上就更新了下 IDEA, 发现这些 bug 依然没有解决.
   > 例如: 当你用 java 写一个 main 方法, 先以`-Dfile.encoding=UTF-8`输出一些日志, 之后马上改了 `-Dfile.encoding=GBK`, 接下来再运行后可能就会出现乱码情况, 但是如果你再执行一次, 乱码可能就没了, 如果乱码还在, 就删掉 IDEA 中编译的 class 文件, 再次执行, 就不会再出现乱码情况了
4. 确保你使用的是一套 log 日志, 而不是多套日志.

   > 多套日志输出可能会出现日志文件有的乱码, 有的输出不乱码的情况.

---

## 附录

---

<h4><font color="green">如果上面内容有问题的话, 可以在下面回复我, 或私信@我.<font></h4>
<h4><font color="blue">本篇文章偏向于乱码原理和一些研究如果想要了解配置思想和配置方式的话, 就请看下我另一篇文章.<font></h4>
> [IDEA控制台乱码问题,原因&解决方式,解决不了算我输](https://blog.csdn.net/u011511756/article/details/107147491)
