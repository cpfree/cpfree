# Mysql 升级

## 升级注意事项

> MySQL 8 使用全局数据字典，其中包括含有关事务表中数据库对象的信息。在以前的版本中，字典数据存储在元数据文件和非事务性系统表中。

1. SQL 是不是兼容: MySQL 8 和 5.7 版本 在 Group by 处理上有些不兼容.

2. 存储过程, 自定义函数, 触发器，一些不规范的 SQL 语句是否能够兼容.

3. 关键字兼容问题: Mysql 8.0 版本删除了一些关键字, 如果 SQL,函数或存储过程中有使用到这些关键字, 则需要修改.

4. 编码问题: MySQL 8.0 的默认字符集 utf8mb4，可能会导致之前数据的字符集跟新建对象的字符集不一致，为了避免新旧对象字符集不一致的情况，可以在配置文件将字符集和校验规则设置为旧版本的字符集和校验规则。此外当前数据库数据表 ddl 编码有问题, 在升级前需要解决,

5. MySQL 存储引擎现在负责提供自己的分区处理程序，而 MySQL 服务器不再提供通用分区支持，InnoDB 和 NDB 是唯一提供 MySQL 8.0 支持的本地分区处理程序的存储引擎。 如果分区表用的是别的存储引擎，存储引擎必须进行修改。要么将其转换为 InnoDB 或 NDB，要么删除其分区。通过 MySQLdump 从 5.7 获取的备份文件，在导入到 8.0 环境前，需要确保创建分区表语句中指定的存储引擎必须支持分区，否则会报错。

6. MySQL 8.0 启动使用的 lower_case_table_names 值必须跟初始化时使用的一致。使用不同的设置重新启动服务器会引入与标识符的排序和比较方式不一致的问题。

7. 数据文件存储格式是不是可以直接升级

8. 数据库配置问题: Mysql 8.0 部分配置和 5.7 的不相兼容, 而且 8.0 版本使用了更加严格的配置, 在升级之前需要修改.

## 升级准备事项

1. 测试库升级，应用验证.
2. my.cnf 配置信息调整.
3. 不兼容的操作方法，影响复制.
4. 一个平稳的过滤，列如先升级一个从库，到所有从库.
5. 最少停机时间，同样生产数据恢复到环境，进行模拟升级，评估时间.
6. 数据验证：验证行数，表的数量 等等.
7. 考虑回滚方案.
8. 数据库备份.

## 升级方式

### MySQL_upgrade

1. 关闭旧的 MySQL 版本(执行慢关闭): 在关闭之前执行完整的清除和修改缓冲区合并操作，以确保 UNDO 日志为空，并确保当发行版对应的文件格式不同时，数据文件也能完全准好。
2. 升级数据字典，这个阶段主要升级 MySQL 库的数据字典表。数据字典的升级在数据库服务启动过程自动完成。
3. 升级 MySQL 库的系统表（剩余的非字典表）；升级 Performance schema、 information schema 、sys schema；升级用户 schema。

   > 在 MySQL 8.0.16 版本之前，需要手动的执行 MySQL_upgrade 来完成该步骤的升级，在 MySQL 8.0.16 版本是由 MySQLd 来完成该步骤的升级。

### 逻辑升级

1. 使用 mysqldump 从旧的 MySQL 版本导出现有数据。
2. 安装新的 MySQL 版本。
3. 将转储文件加载到新的 MySQL 版本中。
4. 运行 mysql_upgrade 实用程序。

## 升级风险

1. 从升级准备开始 到结束，中间包含很多细致的工作。比如版本确认，功能确认，测试，准备，备份，验证，高可用切换等等, 需要大量时间成本
2. 升级成功后, 可能出现一些兼容性问题.
3. SQL 语句兼容问题, 例如查询结果不一致的问题, 需要大量时间去验证.

当前系统本身不稳定, 当前系统数据库表设计不规范, 升级可能带来更多的很难找出来的未知问题, 因此当前不建议升级 Mysql 至 8.0 版本
