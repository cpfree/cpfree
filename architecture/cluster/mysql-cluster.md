# mysql 集群方案

> - <https://blog.51cto.com/u_11022239/3156091>
> - <https://www.iteye.com/blog/yunnick-1845301>

mysql 百万量级以上高可用

## 主从 & 主备 & 主主

1. 主从: 主从解决的是读写压力的分离

   正常情况下, 主机负责写入数据, 从机负责读取数据, 从机需要从主机上面获取bin-log日志以同步数据.
   主机挂了, 因为从机的存在还能正常读取数据, 但是没法写入数据.

   客户端需要判断读写命令, 将读操作发送给从机, 将写操作发送给主机.

   缺点: 主从延迟问题.

2. 主备: 双机热备的实现

   正常情况下: 读写都是主机上, 备机的唯一使命就是同步主机的数据，不对外提供服务。
   如果主机挂了, 则从机会替代主机工作.

   场景
      - 一个主机一个备机
      - 两台机器互为备机
      - 启动两个数据库机器, 但是两个数据库共享同一个磁盘.

   优点: 简单
   缺点:
      - 备机仅仅做备份, 太浪费了备机这台服务器的资源
   
3. 主主: 

   主主就是两台都是主机。同时对外提供读写操作。客户端任意访问提供的一台。

   优点：主主的好处就是可以把写操作也分担一下，但是问题恰恰就出在写操作上，导致主主的架构有很大的局限性。

   缺点：例如主机A有个注册的插入操作，生成的id是50，同一时刻主机B也有个插入操作生成的id也是50。然后它们之间的数据同步了，你说是谁覆盖谁呢？谁覆盖谁都不对！

   因此主主只适用于可以双向复制，覆盖的数据(例如用户登录生成的token)。但是我们平日里绝大部分的数据都不允许。

## 主从复制

Mysql数据库没有增量备份的机制，当数据量太大的时候备份是一个很大的问题。还好mysql数据库提供了一种主从备份的机制，其实就是把主数据库的所有的数据同时写到备份的数据库中。实现mysql数据库的热备份。 

当然要实现mysql双机热备，除了**mysql本身自带的REPLICATION功能**可以实现外，也可以用**Heartbeat**这个开源软件来实现。不过本文主要还是讲如何用mysql自带的REPLICATION来实现mysql双机热备的功能。

### 主从复制原理

MySQL主(master)从(slave)复制的原理：

   1. master将数据改变记录到二进制日志(binary log)中，即配置文件log-bin指定的文件(这些记录叫做二进制日志时间，binary log events)；
   2. slave将master的binary log events拷贝到它的中继日志(relay log)；
   3. slave重新执行中继日志中的事件，将改变反映它自己的数据(数据重演)；

主从配置需要注意的地方：

   1. **从数据库的数据版本不能低于主服务器数据库的版本**, 最好保持版本一致.
   2. 主DB server和从DB server数据库数据结构、数据一致；
   3. 主DB server开启二进制日志，主DB server和从DB server的server_id都必须唯一；

## 双机热备

> <https://www.iteye.com/blog/yunnick-1845301>

#### 1. 背景

   服务器难免会故障，服务器宕机后, 恢复服务器正常可能需要10分钟、几小时甚至几天。从实际经验上看，除非是简单地重启服务器（可能隐患仍然存在），否则往往需要几个小时以上。而如果技术人员不在现场，则恢复服务的时间就更长了。

   双机热备服务针对的是服务器的故障。通过双机热备服务，来避免长时间的服务中断，保证系统长期、可靠的服务。

#### 2. 概念描述

   从广义上讲，就是对于重要的服务，使用两台服务器，互相备份，共同执行同一服务。当一台服务器出现故障时，可以由另一台服务器承担服务任务，从而在不需要人工干预的情况下，自动保证系统能持续提供服务。

   从狭义上讲，双机热备就是使用互为备份的两台服务器共同执行同一服务，其中一台主机为工作机（Primary Server），另一台主机为备份主机（Standby Server）。在系统正常情况下，工作机为应用系统提供服务，备份机监视工作机的运行情况（一般是通过心跳诊断，工作机同时也在检测备份机是否正常），当工作机出现异常，不能支持应用系统运营时，备份机主动接管工作机的工作，继续支持关键应用服务，保证系统不间断的运行。双机热备针对的是IT核心服务器、存储、网络路由交换的故障的高可用性解决方案。

   **双机热备不是无缝、不中断的**，但它能够保证在出现系统故障时，能够很快恢复正常的服务，业务不致受到影响。双机热备都会有一个切换过程，这个切换过程可能是一分钟左右。在切换过程中，服务是有可能短时间中断的。

   双机热备, 不是备份, 热备份指的是：High Available（HA）即高可用，主要保障业务的连续性，实现的方法是故障点的转移. 备份则是强调的数据恢复.

#### 3. 技术选型

   是否使用双机热备，正确的方法是要分析一下系统的重要性以及对服务中断的容忍程度，以些决定是否使用双机热备。换句话说，就是你的用户能容忍多长时间恢复服务，如果服务不能恢复会造成多大的影响。

#### 双机热备组建方式

第一种，双机热备它的工作原理是使用两台服务器，一台作为主服务器（Active），运行应用系统来提供服务。另一台作为备机，安装完全一样的应用系统，但处于待机状态（Standby）。当Active服务器出现故障时，通过软件诊测将Standby机器激活，保证应用在短时间内完成恢复正常使用。

第二种，双机互备方式则是在双机热备的基础上，两个相对独立的应用在两台机器同时运行，但彼此均设为备机，当某一台服务器出现故障时，另一台服务器可以在短时间内将故障服务器的应用接管过来，从而保证了应用的持续性，这种方式实际上是双机热备方案的一种应用。






### 读写分离

1. 读库和写库的数据一致；
2. 写数据必须写到写库；
3. 读数据必须到读库；


集群方案与单节点的差异：

数据库从之前的单节点变为多节点提供服务；
主节点数据，同步从节点数据；
应用程序需要连接2个数据库节点，并且在程序内部实现判断读写操作；
这种方案的缺点：

应用程序需要连接到多个节点，对应用程序而言变得复杂；
这个问题可以通过中间件解决；
如果在程序内部实现，可使用Spring的AOP功能实现；
主从之间的同步，是异步完成，也就意味着是 弱一致性；
可能会导致数据写入主库后，应用程序读取从库获取不到数据，或者可能会丢失数据，对于数据安全性要求比较高的应用是不合适的；
该问题可以通过PXC集群解决；



应用程序会连接到多个节点，使得应用程序的复杂度提升，可以通过中间件方式解决。

应用程序只需要连接到中间件即可，无需连接多个数据库节点；
应用程序无需区分读写操作，对中间件直接进行读写操作即可；
在中间件中进行区分读写操作，读操作发送到从节点，写操作发送到主节点；
这种方式的架构也存在问题，中间件的性能成为系统的瓶颈，但是可以使用多个中间件部署的方式进行缓解。

这样的话，中间件的可靠性得到了保证，但是也带来了新的问题，应用系统依然需要连接2个中间件，增加了应用系统的复杂度。








#### 主从复制具体操作

> 假设已经配置好了两个版本相同, 数据库以及表结构相同的Mysql数据库

1. 主服务器需要开启慢日志

   主服务器做以下配置, 之后重启mysql.

   ```conf
   # 将mysql二进制日志取名为mysql-bin
   log-bin=mysql-bin
   # 二进制日志的格式，有三种：statement/row/mixed,具体分别不多做解释，这里使用mixed
   binlog_format=mixed
   # 为服务器设置一个独一无二的id便于区分，这里使用ip地址的最后一位充当server-id
   server-id=101
   ```

2. 配置从服务器, 步骤可以与主服务器配置保持一致, 唯一的区别是`server-id`需要保持不一致, 之后重启mysql.

3. 主服务器为从服务器分配一个账号, 之后从服务器可以通过这个账号从主服务器获取日志.

   1. 命令行登录mysql, `mysql -uroot -p`
   2. 分配账号

      ```shell
      # GRANT replication slave : 为从服务器分配权限.
      # ON *.* : 分配可以操作哪个数据库数据表
      # TO 'slave'@'%' : 分配到 用户名@ip地址
      # IDENTIFIED BY '123456'; 登录密码
      GRANT replication slave ON *.* TO 'slave'@'%' IDENTIFIED BY '123456'; 
      ```

   3. 查询主服务器日志信息
   
      ![](image/mysql-cluster/1645591932045.png)

      > 执行完之后记录下这两值，然后在配置完从服务器之前不要对主服务器进行任何操作，因为每次操作数据库时这两值会发生改变

4. 设置从服务器

   1. 命令行登录从服务器mysql
   2. 从服务器关闭 slave
      最好关闭一下, 若是以前配置过主从, 则需要关闭

      ```shell
      stop slave;
      ```

   3. 根据上面的日志信息, 开始配置

      ```shell
      # MASTER_HOST  :  设置要连接的主服务器的ip地址
      # MASTER_USER  :  设置要连接的主服务器的用户名
      # MASTER_PASSWORD  :  设置要连接的主服务器的密码
      # MASTER_LOG_FILE  :  设置要连接的主服务器的bin日志的日志名称
      # MASTER_LOG_POS  :  设置要连接的主服务器的bin日志的记录位置（这里注意，最后一项不需要加引号。否则配置失败）
      mysql > CHANGE MASTER TO 
           -> MASTER_HOST "192.168.20.120"
           -> MASTER_USER="slave"
           -> MASTER_PASSWORD "123456"
           -> MASTER_LOG_FILE "mysql-bin000060"
           -> MASTER_LOG_POS "248"
      ```

   4. 启动从服务器

      ```shell
      stop slave;
      ```

   5. 检查配置是否成功

      ```shell
      show slave status;
      ```

5. 测试同步

   1. 在主数据库的一个测试表里面插入数据, 看下从数据库是否能够正常插入.
