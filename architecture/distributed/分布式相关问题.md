---
keys: 
type: copy,blog,trim
url: <>
id: 220124-124425
---

# 分布式问题

## 负载均衡常见问题

### Session会话保持

会话保持就是指在负载均衡器上有这么一种机制,可以识别做客户与服务器之间交互过程的关连性,在作负载均衡的同时,还保证一系列相关连的访问请求会保持分配到一台服务器上｡两次会话间隔大于连接超时值,BIGIP将会将新来的连接认为是新的会话然后进行负载平衡｡

以下四种方案都是可用的方案, 但对于大型项目, Session Sticky, 和数据集中存储是比较有效的解决方案

#### Session Replication

   复制会话，即一个用户访问了一次就把session复制到所有的服务器或这一部分服务器。
   优点：实现简单, 节点少，降低了故障率。
   缺点：
      1，同步Session数据造成了网络带宽的开销。只要Session数据有变化，就需要将数据同步到所有其他机器上，机器越多，同步带来的网络带宽开销就越大。
      2，每台Web服务器都要保存所有Session数据，如果整个集群的Session数据很多（很多人同时访问网站）的话，每台机器用于保存Session数据的内容占用会很严重。
   适用于服务器节点较少的场景

#### cookies based

问题

   1. cookies 长度限制
   2. 不安全
   3. 请求相应都带有Session, 会增大外部带宽, 降低性能, 对于系统服务器来说, 请求相应数据越小, 能够处理的并发请求就越多

#### 粘滞会话(Sticky Sessions)

   1. 基于IP的会话保持 : 负载均衡器在作负载均衡时是根据访问请求的源地址作为判断关连会话的依据｡对来自同一IP地址的所有访问请求在作负载均时都会被保持到一台服务器上去｡在BIGIP设备上可以为“同一IP地址"通过网络掩码进行区分,比如可以通过对IP地址 192.168.1.1进行255.255.255.0的网络掩码,这样只要是来自于192.168.1.0/24这个网段的流量BIGIP都可以认为他们是来自于同一个用户,这样就将把来自于192.168.1.0/24网段的流量会话保持到特定的一台服务器上｡
   2. NginX对简单会话保持的支持(ip_hash)
      每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session 的问题。

   优点 : 结构简单
   问题 : 1. 系统宕机, 数据丢失, 2. 负载均衡器需要做ISO第七层解析, 比第4层要大, 3, 负载均衡器变成了有状态的节点, 内存消耗变大, 容灾能力差

#### Session 数据集中存储

相关方案

   1. 使用数据库存放session
      优点：实现简单
      缺点：增大数据库压力
      适合数据库访问量不大的网站
   2. 使用文件系统存放session
      优点：实现简单
      缺点：I/O性能和网络带宽上存在较大瓶颈, 尤其是对于Session这样的小文件的频繁读写操作。
      适合并发量不大的网站.
   3. 基于浏览器Cookie的Session共享 
      此种方案把用户相关的Session信息存储到浏览器的Cookie中，也称为客户端Session。 
      采用Flash Cookie、URL重写的方式传递Session信息的方案也可以归为此类。 
      缺点：只能够存储字符串、数值等基本类型的数据；Cookie大小存在限制；安全性；带宽及数据解压缩、网络传输性能问题。
   4. 基于中间件缓存,Memcached, redis存储Session
      优点 : 延迟性好, 效率高
      缺点 : 宕机，数据将会丢失。但对 session 数据来说并不是严重的问题。如果网站访问量太大，session太多的时候，memcached会将不常用的部分删除，但是如果用户隔离了一段时间之后继续使用，已经全部乱套了。

缺点 : 时延性, 和不稳定性
使用于服务器节点多, session访问量大的场景

