---
keys: 限流算法,高并发,流量整形
type: turn
urls: <https://zhuanlan.zhihu.com/p/122431276>,<book:Spring Cloud Alibaba>,<https://www.gushiciku.cn/pl/gzDX>
---

# 服务限流算法

> * 瞬时流量过高，服务被压垮？
> * 恶意用户高频光顾，导致服务器宕机？
> * 消息消费过快，导致数据库压力过大，性能下降甚至崩溃？

## 概述

### 服务限流的作用及实现

限流的主要目的是通过限制并发访问数或者限制一个时间窗口内允许处理的请求数量来保护系统，一旦达到限制数量则对当前请求进行处理采取对应的拒绝策略，比如跳转到错误页面拒绝请求、进入排队系统、降级等。从本质上来说，限流的主要作用是损失一部分用户的可用性，为大部分用户提供稳定可靠的服务。比如系统当前能够处理的并发数是10万，如果此时来了12万用户，那么限流机制会保证为10万用户提供正常服务。

### 限流算法示例

1. 开发实例

   在Nginx层添加限流模块限制平均访问速度。
   通过设置数据库连接池、线程池的大小来限制总的并发数。
   通过Guava提供的 Ratelimiter 限制接口的访问速度。
   TCP通信协议中的流量整形。

2. 业务示例

   1. 双11大促销
   2. 限时秒杀
   3. QQ微信限制每分钟消息发送条数

### 计数器算法

指定周期内累加访问次数，当访问次数达到设定的阈值时，触发限流策略，当进入下一个时间周期时进行访问次数的清零。

![计数器算法](https://gitee.com/cpfree/picture-warehouse/raw/master/pic/20210611104745.png)

> * 业务示例: 限定了每一分钟能够处理的总的请求数为100，在第一个一分钟内，一共请求了60次。接着到第二个一分钟，counter又从0开始计数，在一分半钟时，已经达到了最大限流的阈值，这个时候后续的&所有请求都会被拒绝。这种算法可以用在短信发送的频次限制上，比如限制同一个用户一分钟之内触发短信发送的次数。

> * 实例场景: QQ 中群管理员 限制每分钟群内成员发送消息数量不能超过5条

* 临界问题

这种算法存在一个临界问题，在第一分钟的0：58和第二分钟的1：02这个时间段内，分别出现了100个请求，整体来看就会出现4秒内总的请求量达到200，超出了设置的阈值。

### 滑动窗口算法

为了解决计数器算法带来的临界问题，所以引入了滑动窗口算法。滑动窗口是一种流量控制技术，在TCP网络通信协议中，就采用了滑动窗口算法来解决网络拥塞的情况。

滑动窗口算法的原理是在固定时间周期中分割出多个小时间周期，分别在每个小时间窗口中记录访问次数，然后根据时间将窗口往前滑动并删除过期的小时间窗口。最终只需要统计滑动窗口范围内的所有小时间窗口总的计数

![滑动窗口算法](https://gitee.com/cpfree/picture-warehouse/raw/master/pic/20210611104813.png)

在上图中，整个红色的矩形框表示一个时间窗口，在我们的例子中，一个时间窗口就是一分钟。然后我们将时间窗口进行划分，比如图中，我们就将滑动窗口划成了6格，所以每格代表的是10秒钟。每过10秒钟，我们的时间窗口就会往右滑动一格。每一个格子都有自己独立的计数器counter，比如当一个请求 在0:35秒的时候到达，那么0:30~0:39对应的counter就会加1。

* 那么滑动窗口怎么解决刚才的临界问题的呢

   在上图中，0:59到达的100个请求会落在灰色的格子中，而1:00到达的请求会落在橘×××的格子中。当时间到达1:00时，我们的窗口会往右移动一格，那么此时时间窗口内的总请求数量一共是200个，超过了限定的100个，所以此时能够检测出来触发了限流。

> 回顾一下上面的计数器算法，我们可以发现，计数器算法其实就是滑动窗口算法。只是它没有对时间窗口做进一步地划分，所以只有1格。

> 由此可见，当滑动窗口的格子划分的越多，那么滑动窗口的滚动就越平滑，限流的统计就会越精确。

* BTW：

   1. 滑动窗口算法是以当前这个时间点为基准，往前推移1秒进行计算当前1秒内的请求量情况。
   2. 滑动窗口限流统计的精准度是由划分的格子多少决定的，这个怎么理解呐，就是把1秒中进行划分成多个时间段，比如2个格子的话，那么就是2段，0-500ms和501-1000ms。那么就会两个值进行存储统计请求量，比如数组 [0,1] 各存储一个段的请求值。
   3. 计算器算法是滑动窗口算法将时间段划分为1的特殊情况。

### 令牌桶限流算法

令牌桶是网络流量整形（Traffic Shaping）和速率限制（Rate Limiting）中最常使用的一种算法。

![令牌桶限流算法](https://gitee.com/cpfree/picture-warehouse/raw/master/pic/20210611150528.png)

系统会**以一定的速率往桶里添加令牌**，对于每一个请求，**处理前都需要先从令牌桶中获得一个令牌**，如果**没有获得令牌则触发限流策略**, **桶设置最大的放置令牌限制**，当**桶满时新添加的令牌就被丢弃或者拒绝**；

* 实现关键点

   初始化固定数量的令牌放入令牌桶中
   初始化和开启一个定时的任务，定时往令牌桶添加令牌
   提供一个获取令牌的方法，获取一个令牌，令牌桶中减一，如果令牌桶中为空，返回失败
   还是说干就干，以下就是简单的实现TokenLimiter，

令牌桶限流算法

在请求获取令牌的时候，会存在三种情况：

   1. 请求速度大于令牌生成速度：那么令牌会很快被取完，后续再进来的请求会被限流。
   2. 请求速度等于令牌生成速度：此时流量处于平稳状态。
   3. 请求速度小于令牌生成速度：说明此时系统的并发数并不高，请求能被正常处理。

由于令牌桶有固定的大小，当请求速度小于令牌生成速度时，令牌桶会被填满。所以令牌桶能够处理突发流量，也就是在短时间内新增的流量系统能够正常处理，这是令牌桶的特性。

### 漏桶限流算法

![漏桶限流算法](https://gitee.com/cpfree/picture-warehouse/raw/master/pic/20210611151454.png)

漏桶限流算法的主要作用是**控制数据注入网络的速度**，**平滑网络上的突发流量**。

漏桶算法内部同样维护一个容器，这个容器会以恒定速度出水，不管上面的水流速度多快，漏桶水滴的流出速度始终保持不变。

> 典型使用案例: 消息中间件(不管生产者的请求量有多大，消息的处理能力取决于消费者。)

在漏桶限流算法中，存在以下几种可能的情况：

   1. 请求速度大于漏桶流出水滴的速度：也就是请求数超出当前服务所能处理的极限，将会触发限流策略。
   2. 请求速度小于或者等于漏桶流出水滴的速度，也就是服务端的处理能力正好满足客户端的请求量，将正常执行。

漏桶限流算法和令牌桶限流算法的实现原理相差不大，最大的区别是漏桶无法处理短时间内的突发流量，漏桶限流算法是一种恒定速度的限流算法。

---

### 滑动日志限流算法

上面四种算法都主要是为了`保护服务器正常运行`而对请求进行限制, 而滑动日志算法更像是只为限制请求数量, 而限制请求.

滑动日志限流算法需要记录请求的时间戳，通常使用有序集合来存储，我们可以在单个有序集合中跟踪用户在一个时间段内所有的请求。

假设我们要限制给定T时间内的请求不超过N，我们只需要存储最近T时间之内的请求日志，每当请求到来时判断最近T时间内的请求总数是否超过阈值。

> 滑动日志限流算法可以看作是`滑动窗口限流为每个时间戳窗口均分配了一个小窗口`

滑动日志能够避免突发流量，相对于滑动窗口算法实现较为精准的限流, 同时也可以实现更加灵活的多级限流

但缺陷明显, 就是占用存储空间要高于其他限流算法。

---

## 分布式限流

上面几种限流算法通过简单改造就可以实现分布式限流

例如

* nginx代理服务就提供了限流模块，不管外界请求如何多, 而流向服务器的请求是有限的, 其底层是漏桶算法.
* 消息中间件也是分布式限流算法的作用, 其底层也是漏桶算法.

## 几种限流算法总结

固定窗口算法实现简单，性能高，但是会有临界突发流量问题，瞬时流量最大可以达到阈值的2倍。

滑动窗口算法可以解决固定窗口算法的临界突发流量，但是当流量到达阈值时会瞬间掐断流量，所以导致流量不够平滑。

想要达到限流的目的，又不会掐断流量，使得流量更加平滑？可以考虑漏桶算法！需要注意的是，漏桶算法通常配置一个FIFO的队列使用以达到允许限流的作用。

由于速率固定，即使在某个时刻下游处理能力过剩，也不能得到很好的利用，这是漏桶算法的一个短板。

限流和瞬时流量其实并不矛盾，在大多数场景中，短时间突发流量系统是完全可以接受的。令牌桶算法就是不二之选了，令牌桶以固定的速率v产生令牌放入一个固定容量为n的桶中，当请求到达时尝试从桶中获取令牌。

当桶满时，允许最大瞬时流量为n；当桶中没有剩余流量时则限流速率最低，为令牌生成的速率v。

如何实现更加灵活的多级限流呢？滑动日志限流算法了解一下！这里的日志则是请求的时间戳，通过计算制定时间段内请求总数来实现灵活的限流。

当然，由于需要存储时间戳信息，其占用的存储空间要比其他限流算法要大得多。

选择限流算法时, 需要从性能，是否允许超出阈值，落地成本，流量平滑度，是否允许突发流量以及系统资源大小限制多方面考虑。

市面上也有比较成熟的限流工具和框架。

* 如Google出品的Guava中基于令牌桶实现的限流组件
* alibaba开源的面向分布式服务架构的流量控制框架Sentinel
