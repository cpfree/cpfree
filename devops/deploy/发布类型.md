# 发布类型

## 灰度发布／金丝雀发布

> 灰度发布就是常说的金丝雀发布, 金丝雀对瓦斯极敏感，矿井工人携带金丝雀，以便及时发发现危险

在原有版本可用的情况下，同时部署少量新版本应用作为“金丝雀”，测试新版本的性能和表现，以保障整体系统稳定的情况下，尽早发现、调整问题。确认没有异常之后，再更新到其余的服务器上。可以使用修改权重的方式让某几台服务器优先被访问。

灰度发布／金丝雀发布由以下几个步骤组成：

   1. 准备好部署各个阶段的工件，包括：构建工件，测试脚本，配置文件和部署清单文件。
   2. 从负载均衡列表中移除掉“金丝雀”服务器。
   3. 升级“金丝雀”应用（排掉原有流量并进行部署）。
   4. 对应用进行自动化测试。
   5. 将“金丝雀”服务器重新添加到负载均衡列表中（连通性和健康检查）。
   6. 如果“金丝雀”在线使用测试成功，升级剩余的其他服务器。（否则就回滚）

## 蓝绿部署

蓝绿部署是一种以可预测的方式发布应用的技术，目的是减少发布过程中服务停止的时间。

步骤

   1. 准备两套一模一样的生产环境（基础架构），且两者之间没有耦合情况。对外提供服务的一套为绿色环境，不对外的一套为蓝色环境。
   2. 如果有新功能先发布到蓝色环境，不影响绿色环境的使用。
   3. 反复测试修改验证没有问题后，将用户切到蓝色环境(负载均衡器／反向代理／路由切换)，
   4. 切换后的一段时间内，需要监测新版本应用是否有故障和异常
      - 如果有问题再切回绿色环境。
      - 如果没有问题，蓝色环境就成为新的绿色环境，原绿色环境释放，用于部署下一个蓝色环境。

理论上听起来很棒，但还是要注意一些细节：

   1. 当你切换到蓝色环境时，需要妥当处理未完成的业务和新的业务。如果你的数据库后端无法处理，会是一个比较麻烦的问题；
   2. 有可能会出现需要同时处理“微服务架构应用”和“传统架构应用”的情况，如果在蓝绿部署中协调不好这两者，还是有可能导致服务停止的；
   3. 需要提前考虑数据库与应用部署同步迁移 /回滚的问题；
   4. 蓝绿部署需要有基础设施支持, 在非隔离基础架构（ VM 、 Docker 等）上执行蓝绿部署，蓝色环境和绿色环境有被摧毁的风险

## A/B Testing

A/B测试不同于蓝绿发布和金丝雀发布，前两种方式是一种发布策略，目标是确保新上线的服务是否问题，是否存在BUG隐患等等。而A/B测试完全是一种效果测试，它允许多个版本的服务同时对外提供访问，比如A版本的主题是蓝色，B版本的主题是红色，然后对比不同版本的用户量，最终选出最合适的版本。

A/B 测试是用来测试应用功能表现的方法，例如可用性、受欢迎程度、可见性等等。 A/B 测试通常用在应用的前端上，不过当然需要后端来支持。

A/B 测试与蓝绿部署的区别在于， A/B 测试目的在于通过科学的实验设计、采样样本代表性、流量分割与小流量测试等方式来获得具有代表性的实验结论，并确信该结论在推广到全部流量可信；蓝绿部署的目的是安全稳定地发布新版本应用，并在必要时回滚。

A/B 测试和蓝绿部署可以同时使用。
